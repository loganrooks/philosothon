# Holistic Review: RegistrationDialog Feature (V3.1) - Detailed Analysis v5

**Date:** 2025-04-24
**Reviewer:** Holistic Reviewer Mode
**Commit Reviewed:** `f86178b8a0d62e1033e64e576a9d467a007a3231` (on `feature/registration-v3.1-impl`)

## 1. Review Scope

This review provides a detailed analysis of the `RegistrationDialog` feature implementation against V3 specifications, focusing on:

*   **Code:**
    *   `platform/config/registrationSchema.ts` (SSOT)
    *   `platform/src/app/register/data/registrationQuestions.ts` (Generated Data)
    *   `platform/src/app/register/components/RegistrationDialog.tsx` (Component Logic)
    *   `platform/src/app/register/components/RegistrationDialog.test.tsx` (Tests)
*   **Documentation:**
    *   `docs/project_specifications_v3.md` (Overall V3 Spec)
    *   `docs/architecture/terminal_component_v2.md` (Terminal Architecture)
    *   `docs/event_info/registration_outline.md` (V3.1 Questionnaire Content)
    *   `docs/plans/phase_3_plan.md` (Implementation Plan)
    *   Relevant Memory Bank entries (`activeContext.md`, `globalContext.md`, `holistic-reviewer.md`)
    *   Older specs (`project_specifications_v2.md`, `terminal_component_v1.md`, etc.) for archival context.
*   **Objective:** Perform a detailed comparison of documentation, code, and tests; identify conflicts/gaps; evaluate TDD adherence and test quality with specific examples and justifications; analyze potential lost features and architectural alignment; analyze the V3 plan; propose detailed resolutions; recommend archival; deliver detailed report.

## 2. Documentation Analysis (Detailed & Justified)

*   **Consistency:** **High.** V3 documents show strong internal consistency, verified by reading the specified files.
    *   **Example:** `project_specifications_v3.md` (Sec 3.2) mandates the V3.1 questionnaire via Terminal UI, referencing `p0_registration_terminal_ui_spec_v2.md`. This V3.1 spec details terminal commands (`back`, `edit`, `review`, etc.) and input types like `ranked-choice-numbered`. `registration_outline.md` provides the exact 36 questions (e.g., Q18/Q20 for ranking), matching the count and content reflected in the SSOT (`registrationSchema.ts`, lines 503-530, 549-577). `terminal_component_v2.md` provides the architectural pattern (`TerminalShell`/`ActiveDialog`) used by `RegistrationDialog.tsx`. `phase_3_plan.md` correctly prioritizes implementing this V3.1 registration flow (Phase 3.2).
    *   **Conclusion:** Documentation provides a clear, consistent, and verifiable target for implementation based on direct file content review.
*   **Gaps Noted (Elaborated & Justified):**
    *   *Terminal File Upload (V3 Spec 3.8.1):* The spec explicitly flags the need to define the mechanism ("*Needs further definition...*"). **Impact:** Blocks P3 Submission feature implementation. Requires architectural decision on how a terminal UI securely handles file selection and transfer (e.g., triggering native input, using specific commands, linking to web form). This gap is confirmed by the lack of detail in the spec itself.
    *   *Philosophical Text Management (V3 Spec 3.3.4):* Strategy (Markdown vs. DB) is marked TBD ("*Requires investigation...*"). **Impact:** Blocks P2 Library/Gamification implementation, specifically the AI Agent MCP's data source and text embedding pipeline. This gap is confirmed by the explicit TBD marker in the spec.
*   **Archival Recommendations (Justification):**
    *   `docs/project_specifications.md` (V1 MVP): Superseded by V2/V3's expanded scope (built-in registration, terminal UI, gamification). **Justification:** Prevents confusion regarding MVP goals vs. current V3 goals.
    *   `docs/project_specifications_v2.md`: Superseded by V3's shift to the Terminal UI as the central hub and updated feature set/priorities. **Justification:** Avoids confusion about feature scope (e.g., V2's detailed gamification vs. V3's phased approach) and outdated decisions (e.g., V2 considered platform-integrated messaging).
    *   `docs/architecture/terminal_component_v1.md`: Superseded by V2 which recommends XState and defines more dialogs for V3 scope. **Justification:** Ensures developers use the latest architectural guidance, especially regarding state management recommendations.
    *   `docs/specs/p0_registration_spec.md`: Likely superseded by `p0_registration_terminal_ui_spec_v2.md` which details the V3.1 terminal-specific flow. **Justification:** Avoids conflicting registration specifications.
*   **Plan Analysis (`docs/plans/phase_3_plan.md`):**
    *   **Strengths:** Provides a clear, phased approach (3.1-3.6) aligned with V3 spec priorities (P0-P4). Defines specific feature branches (Sec 2). Includes TDD anchors for each phase (e.g., Phase 3.1 Step 1: "Test Server Actions, middleware protection, session handling"). Acknowledges key technical considerations like terminal complexity and testing strategy (Sec 4).
    *   **Weaknesses/Areas for Improvement (Detailed):**
        *   *Dependency Granularity:* While high-level phase dependencies are noted (e.g., Phase 3.2 depends on 3.1), dependencies *within* phases or between parallelizable steps (like Phase 3.4) could be more explicit. For example, does `Gamification Core` depend on `Terminal Library` being complete? **Recommendation:** Add a dependency graph or more detailed prerequisites for tasks within phases.
        *   *Testing Strategy Detail:* Section 4 mentions adapting testing strategies but could be more prescriptive. **Recommendation:** Explicitly recommend specific strategies based on known issues (e.g., "Prioritize Playwright for flows involving `awaiting_confirmation` state due to JSDOM limitations observed in `REG-TEST-TIMING-001`").
        *   *Risk Mitigation:* While considerations are listed, the plan lacks explicit mitigation strategies. **Recommendation:** For key risks (e.g., terminal complexity, AI backend setup), add contingency plans (e.g., "If XState proves too complex initially, fall back to `useReducer` for shell state but schedule refactor").
        *   *TDD Anchor Specificity:* Anchors like "Test Server Actions" are too vague. **Recommendation:** Enhance anchors with specific behaviors, e.g., "TDD Anchor (Auth V2): Test `signInWithPassword` action returns success on valid credentials", "Test `signInWithPassword` action returns specific error on invalid password". This provides clearer targets for `tdd` mode.
        *   *Review/QA Integration:* The plan focuses on implementation phases but doesn't explicitly schedule review cycles (like this holistic review, security reviews, or QA testing) between phases or major feature merges. **Recommendation:** Integrate explicit review/QA checkpoints into the phase transitions to catch issues earlier.
    *   **Conclusion:** A solid high-level plan aligned with specs, but requires enhancement in dependency mapping, testing strategy specifics, and risk mitigation for improved execution clarity.
*   **Missing Documentation Helpful for SPARC/TDD:**
    *   *Component Interaction Diagrams:* Lack of sequence diagrams illustrating data flow/props between `TerminalShell` and `RegistrationDialog` makes understanding complex state transitions harder for implementation and testing.
    *   *Explicit TDD Anchors in Specs:* Specs could define testable behaviors more granularly (e.g., "Anchor: Test `handleSubmit` correctly parses `OptionNumber:Rank` format") to give `tdd` mode clearer targets.
    *   *Style Guide Integration:* `docs/style_guide.md` exists but isn't explicitly linked from component specs, potentially hindering visual consistency efforts.

## 3. Code vs. Specification Analysis (Detailed & Justified)

*   **Schema (`registrationSchema.ts`):** **PASS.** Excellent SSOT implementation.
    *   **Evidence:** Defines all 36 questions from `registration_outline.md` with correct `order`. Includes V3.1 types like `ranked-choice-numbered` (line 16) and `scale` (line 12). Mandates `hint` (line 27) and `description` (line 28). Crucially, `validationRules` (lines 28-44) accurately reflect spec decisions, e.g., `minRanked: { value: 3 }` (line 41) for ranking questions (Q18/Q20 in outline), aligning with spec decision log. `dbType` hints (lines 47-54) support the generation script.
    *   **Conclusion:** Provides a solid, spec-aligned foundation for registration data structure and validation, confirmed by direct comparison with `registration_outline.md`.
*   **Generated Data (`registrationQuestions.ts`):** **PASS (with minor issue).**
    *   **Evidence:** Correctly reflects the structure and content defined in `registrationSchema.ts`, providing the necessary `questions` array (line 94 onwards) for the component (verified by comparing array structure against schema).
    *   **Minor Issue:** `FormDataStore` type (lines 42-91) uses `any`. **Impact:** Reduces type safety in `RegistrationDialog.tsx` when accessing `state.answers` (line 77), potentially masking errors (e.g., treating `string[]` from multi-select as `string`). **Recommendation:** Update `scripts/generate-registration.ts` to map `QuestionDefinition.type`/'dbType' to specific TypeScript types (e.g., `'multi-select-numbered'` -> `string[]`, `'ranked-choice-numbered'` -> `Array<{ optionValue: string; rank: number }>` or similar, `'scale'` -> `number`).
*   **Component (`RegistrationDialog.tsx`):** **PARTIAL PASS.**
    *   **Evidence:** Implements `useReducer` (lines 53-96, 116), early auth flow (lines 136-162, 253-304), most input types (validation logic within `handleSubmit`, lines 504-581), and commands (`back`, `review`, `help`, `save`, `exit`, `edit` within `handleSubmit`, lines 388-492).
    *   **Discrepancy 1 (Code vs. Spec - `ranked-choice-numbered`):** **High Impact.** `handleSubmit` (lines 245-619) lacks a specific `else if (currentQuestion.type === 'ranked-choice-numbered')` block, falling through to default text logic (lines 569-581). **Impact:** Cannot parse `OptionNumber:Rank,...` format, validate against schema rules (`minRanked: 3`, uniqueness from schema lines 41-42), or store data correctly (schema expects `JSONB` line 575). Breaks core functionality for theme/workshop ranking (Q18/Q20). **Resolution:** Implement parsing and validation logic for this type within `handleSubmit`.
    *   **Discrepancy 2 (Code vs. Spec - Email Confirmation):** **Medium Impact.** `awaiting_confirmation` logic (lines 305-361) uses a placeholder `checkConfirmationStatus` function (line 99, called line 316) returning `false`. `resend` command logic (lines 335-358) lacks implementation. **Impact:** Breaks V3.1 spec (Sec 3.2.3) verification flow. **Resolution:** Replace placeholder `checkConfirmationStatus` with actual Supabase session/user status check. Implement `resend` logic (e.g., re-call `initiateOtpSignIn`).
    *   **Discrepancy 3 (Code vs. Spec - Partial Completion Load):** **Medium Impact.** Component lacks logic to load saved state from `localStorage` on mount (no `useEffect` checking `localStorage`) and handle the `register continue` command (missing in `handleSubmit`). **Impact:** The `save` feature (lines 412-433) is currently ineffective as users cannot resume progress, contradicting V3.1 spec (`p0_registration_terminal_ui_spec_v2.md` Sec 3.2.4). **Resolution:** Add `useEffect` hook to check `localStorage` on mount, dispatch `LOAD_STATE` if data exists, and implement `register continue` command handling in `handleSubmit`.
    *   **Code Hygiene (SPARC Violation):** 643 lines exceeds <500 line guideline. **Impact:** Reduced readability, increased cognitive load, harder testing/maintenance (esp. monolithic `handleSubmit` approx. 370 lines). **Recommendation:** Refactor *after* fixing functional gaps and stabilizing tests. Extract validation logic (e.g., `validateMultiSelectNumbered` from lines 528-567). Extract command handling (e.g., `handleReviewCommand` from lines 364-387). Consider `useRegistrationReducer` custom hook (lines 50-96, 116-117).

## 4. Test Suite Analysis (`RegistrationDialog.test.tsx`) - Detailed Investigation (Enhanced Detail & Justification)

*   **File Structure & Size:** Excessively long (>2100 lines) and highly repetitive, severely impacting maintainability. Setup logic (simulating flow to specific questions, e.g., lines 738-777, 1720-1748, 2089-2103) is copied extensively.
*   **Status (Commit `192b50c`):** 35 Passed, 1 Skipped, 32 TODO. (Verified via MB log `[2025-04-24 14:14:32]`)
*   **Skipped Test Analysis (Line 79):**
    *   `it.skip('should prompt for First Name', () => {});`
    *   **Evaluation:** Redundant, covered by subsequent tests (e.g., line 81). **Justification for Skip vs. Delete:** Skipping preserves the explicit test case intent, making it clear it was considered and intentionally omitted for redundancy. **Recommendation:** Add comment `// Skipped: Redundant - Covered by 'should prompt for Last Name...' test.`
*   **TODO Test Analysis (32 tests) - Detailed Evaluation:**
    *   **`awaiting_confirmation` state (lines 513-514):** `should display confirmation instructions...`, `should periodically call checkEmailConfirmation...` - **Alignment:** Directly reflects V3.1 spec requirement. **Thoroughness:** Needs expansion. **Missing Anchors:** Explicit tests for `continue` command failing when `checkConfirmationStatus` (mocked) returns false, and succeeding when true. Test for `resend` command triggering the appropriate action (e.g., re-calling `initiateOtpSignIn`). **Recommendation:** Add specific `it.todo` placeholders for these `continue`/`resend` scenarios.
    *   **Existing User Handling (line 722):** `should handle existing users detected during signUpUser...` - **Alignment:** Reflects V3.1 spec requirement. **Thoroughness:** Placeholder is vague. **Missing Anchors:** Needs specific tests for scenarios: a) `initiateOtpSignIn` indicates user exists but unconfirmed -> transition to `awaiting_confirmation`; b) user exists and is confirmed -> potentially show error or different flow (needs spec clarification). **Recommendation:** Refine this TODO into multiple specific scenarios.
    *   **Question Flow (lines 817-820):** `should display questions sequentially...`, `should display question hints`, `should display question descriptions`, `should correctly format the prompt...` - **Alignment:** Covers basic spec requirements. **Thoroughness:** Good placeholders. **Missing Anchors:** Could add TODO for testing `dependsOn`/`dependsValue` skip logic (e.g., ensuring `academicYearOther` Q7 is skipped if Q6 answer is not 'Other'). **Recommendation:** Add specific TODO for skip logic.
    *   **Command Handling (lines 1667-1669, 1851, 1853-1858):** Covers `next`, `prev`, `submit`, submit action calls, error handling, success state, disabling prev/next. **Alignment:** Directly maps to commands specified in `p0_registration_terminal_ui_spec_v2.md`. **Thoroughness:** Good coverage of command lifecycle. **Missing Anchors:** Specific tests for `submit` command triggering `submitRegistration` action and correctly handling both success (`SET_MODE: 'success'`) and error (displaying error message) responses from the mocked action. **Recommendation:** Ensure `submit` TODOs include success/error path verification.
    *   **Local Storage (lines 2168-2170):** Covers loading data, prompting continue/restart, clearing on submit/exit. **Alignment:** Directly relates to the `save`/`continue` flow from V3.1 spec. **Thoroughness:** Covers key aspects. **Missing Anchors:** Test for handling potential errors during `localStorage.getItem` or `JSON.parse`/`atob` on load. **Recommendation:** Add TODO for error handling during load.
    *   **Shell/Backend Interaction (lines 2173-2177, 2181-2185):** Placeholders for verifying calls. **Alignment:** Necessary for testing integration points (Arch V2). **Thoroughness:** Basic placeholders. **Recommendation:** Refine TODOs to specify *which* arguments should be passed to actions (e.g., `submitRegistration` should receive the complete `answers` object) and how the component should react to different mock return values (success/error objects).
    *   **Overall TODO Evaluation:** The TODOs provide a comprehensive roadmap aligned with V3.1 specs. No obvious missing anchors, but specific scenarios within TODOs (like existing user states) need refinement during implementation. **Recommendation:** Keep these TODOs and flesh them out with specific assertion details when implementing the corresponding features.
*   **Passing Test Evaluation (35 tests) - Detailed:**
    *   **Coverage:** Superficially covers implemented features.
    *   **Thoroughness & Reliability:** **Low.**
        *   *State Verification:* Primarily asserts mocked output (`mockAddOutputLine`). Lacks direct state assertions (e.g., checking `state.answers` after line 280 `dispatch({ type: 'SET_ANSWER'... })`). **Risk:** Correct output could mask incorrect state updates.
        *   *Timing Fragility (`REG-TEST-TIMING-001`):* Heavy `waitFor` use. Critical assertions for *next prompt* display are often commented out/removed (e.g., lines 790, 807, 1136, 1286, 1477, 1987) as a workaround. Relies on asserting *absence* of errors (e.g., line 1285: `expect(mockAddOutputLine).not.toHaveBeenCalledWith(...)`). **Risk:** Unreliable; false positives likely. Example: Test 'should handle valid numeric input...' (line 1102) asserts the *next* prompt 'University / Institution' (line 1137) appears, but doesn't verify `state.answers.academicYear` was actually set to 'Second year'.
        *   *Incomplete Validation Assertions:* `ranking-numbered` validation tests (lines 1482-1659) have specific error message assertions commented out (e.g., `// expect(mockAddOutputLine).toHaveBeenCalledWith(expect.stringContaining('Invalid format...'))` line 1521). **Risk:** Tests pass against incomplete code, failing to verify crucial validation logic defined in the SSOT (`registrationSchema.ts`, lines 524, 571 require specific format/rank checks).
    *   **TDD Adherence Justification (Detailed):**
        *   **Compromised Cycle (Commented Assertions):** The commented-out validation assertions (e.g., ranking errors, lines 1521, 1538, etc.) directly violate TDD. These assertions align with specific `validationRules` in `registrationSchema.ts` (e.g., `minRanked`, format checks). TDD requires writing these failing tests (Red), then writing *minimal component code* to make *those specific assertions* pass (Green). Commenting them out bypasses the Green phase for that specific requirement, allowing the test suite to pass prematurely without verifying the component meets the spec's validation details.
        *   **Weakened Assertions (Timing Workarounds):** Removing assertions for the *next expected prompt* (e.g., line 807) and checking only for the *absence* of errors deviates from TDD's goal of positive confirmation. While `REG-TEST-TIMING-001` is a factor, the workaround reduces confidence. A TDD approach would involve deeper investigation into the timing issue or using more robust assertion methods.
*   **Overall Quality Assessment (Revised):** Extremely poor maintainability (length >2100, repetition e.g., lines 738-777 vs 1720-1748). Low reliability (timing workarounds, incomplete/inaccurate assertions). Compromised TDD alignment. Requires major refactoring to be trustworthy.
*   **Detailed Refactoring Recommendations:**
    1.  **Reduce Repetition:** Implement `async function simulateFlowToQuestion(targetIndex, initialAnswers, renderFn)` and `async function simulateInputCommand(command, inputElement, handleInputMock)`.
    2.  **Improve State Assertions:** Refactor component state logic (lines 50-96, 116-117) into `useRegistrationReducer` hook, export state/dispatch for testing, and add direct state assertions.
    3.  **Address Timing Issues:** Investigate `REG-TEST-TIMING-001`. Use `act` wrapper consistently (e.g., lines 1122, 1162). Consider Playwright for critical async flows if JSDOM limits persist.
    4.  **Reinstate/Correct Assertions:** **Crucially,** uncomment and fix validation assertions (e.g., ranking errors lines 1521, 1538, etc.) to match `registrationSchema.ts` requirements (strict Red-Green). Reinstate assertions for *expected next prompts* where feasible.
    5.  **Skipped Test:** Add comment to line 79: `// Skipped: Redundant - Covered by 'should prompt for Last Name...' test.`
    6.  **Structure:** Use nested `describe` blocks for better organization.

## 5. Lost Features / Spec Evolution Analysis (Detailed & Justified)

*   **Partial Completions (`save`/`continue`):**
    *   **V3.1 Spec (`p0_registration_terminal_ui_spec_v2.md` Sec 3.2.4):** Explicitly requires `save` ("Save current progress to local storage and exit") and `register continue` ("Load saved progress from local storage and resume").
    *   **Implementation (`RegistrationDialog.tsx`):**
        *   `save` command logic exists (lines 412-433), using `localStorage.setItem('philosothon-registration-v3.1', btoa(JSON.stringify(stateToSave)))`. This correctly attempts to save relevant state (`answers`, `currentQuestionIndex`, `mode`). Tests verify this save logic (lines 2084-2167).
        *   **Missing Load Logic:** There is no corresponding `useEffect` hook that runs on component mount to check `localStorage.getItem('philosothon-registration-v3.1')`, parse the data (`atob`, `JSON.parse`), and dispatch a `LOAD_STATE` action (defined in reducer line 82) to restore the saved state.
        *   **Missing `continue` Command:** The `handleSubmit` function (lines 245-619) does not include a case for `input.toLowerCase() === 'register continue'` or similar to trigger the loading logic.
    *   **Evaluation:** The persistence feature is only half-implemented. The `save` command writes data, but without the loading mechanism and `continue` command, the saved data is never retrieved or used, rendering the save functionality useless. This directly contradicts the spec's requirement for resuming progress. **Medium Priority** gap. **Recommendation:** Implement the loading `useEffect` hook and the `register continue` command handler in `handleSubmit`. Activate TODO tests (lines 2168-2170) which correctly identify the need for loading tests.
*   **Other Lost Features (V2 vs V3):**
    *   *V2 Enhanced Reg Fields (V2 Sec 3.2.4):* Fields like "Date Flexibility", "Philo Background", "Team Prefs", "Tech Exp", "Accessibility" are largely incorporated into the 36 questions of V3.1 (`registration_outline.md`). **Conclusion:** Refined, not lost.
    *   *V2 Team Formation/Comms (V2 Sec 3.4):* Explicitly deferred to P1/P2 in V3 plan (`phase_3_plan.md` Phase 3.3). **Conclusion:** Intentional phasing.
    *   *V2 Gamification Details (V2 Sec 3.5):* V3 retains core concept but defers detailed mechanics to P2 (`phase_3_plan.md` Phase 3.4). **Conclusion:** Intentional phasing/scoping change.
    *   *V2 Submission/Judge Portals (V2 Sec 3.6/3.7):* Deferred to P3 in V3 (`phase_3_plan.md` Phase 3.5). **Conclusion:** Intentional phasing.
    *   **Overall Conclusion:** No major features appear accidentally *lost* between V2 and V3 specs. The main issue identified is the **incomplete implementation of the specified `save`/`continue` flow** for partial registrations within the current V3.1 context.

## 6. Terminal Implementation vs. Architecture Analysis (Detailed & Justified)

*   **Architecture Document:** `docs/architecture/terminal_component_v2.md`
*   **Evaluation (`RegistrationDialog.tsx` vs. Arch V2):**
    *   **Pattern Adherence:** Follows `TerminalShell`/`ActiveDialog` pattern. `RegistrationDialog` is designed as a self-contained unit handling a specific mode ('registration', 'early_auth', 'awaiting_confirmation'), intended to be dynamically rendered by a parent `TerminalShell`. **PASS.**
    *   **State Management:** Uses `useReducer` (line 116) as allowed for dialogs (Arch V2 Sec 4). **PASS (for dialog).** (Note: Shell implementation not reviewed here).
    *   **Communication:** Uses props `addOutputLine` (e.g., line 130), `sendToShellMachine` (e.g., line 436 for 'exit') passed down from the shell, aligning with Arch V2 (Sec 5 & 6). **PASS.**
    *   **Dialog Interface:** Component props (`DialogProps`, lines 14-23) generally match the interface suggested in Arch V2 (Sec 6), including interaction functions (`addOutputLine`, `sendToShellMachine`, `changeMode`) and context (`userSession`, `dialogState`). **PASS.**
    *   **SPARC Adherence:** Violates <500 line guideline (643 lines). **FAIL (SPARC).** **Impact:** Reduced maintainability, testability, and increased cognitive load, contradicting SPARC principles for modularity and simplicity. The large `handleSubmit` function (approx. 370 lines) is the primary contributor.
*   **Conclusion:** Architecturally sound regarding the specified modular pattern. The component correctly functions as a dialog within the intended structure. The significant SPARC violation regarding size, however, poses a major maintainability risk and requires refactoring (as previously recommended).

## 7. Summary of Findings & Recommendations (Revised v5)

| Area        | Finding                                                                         | Resolution Recommendation                     | Priority | Consultation Needed? | Justification / Impact                                                        |
| :---------- | :------------------------------------------------------------------------------ | :---------------------------------------- | :------- | :------------------- | :---------------------------------------------------------------------------- |
| **Code**    | Missing `ranked-choice-numbered` input handling in `RegistrationDialog`         | Update Code                               | High     | No                   | Breaks core V3.1 ranking feature (Q18/Q20). Component cannot parse/validate/store. |
| **Tests**   | `RegistrationDialog.test.tsx` quality issues (length, repetition, fragility, TDD deviations, reliability) | **Refactor Tests (Detailed)**             | **High** | No                   | Unreliable tests block confident development/verification. False positives likely. |
| **Code**    | Incomplete `save`/`continue` flow (Partial Registration) in `RegistrationDialog` | Update Code (Add Load Logic & `continue` Cmd) | Medium   | No                   | V3.1 spec feature is half-implemented; `save` is ineffective without `continue`. |
| **Code**    | Incomplete email confirmation flow logic in `RegistrationDialog`                | Update Code                               | Medium   | No                   | Breaks V3.1 user verification flow. Placeholder logic prevents completion.    |
| **Code**    | `RegistrationDialog.tsx` exceeds 500 lines (SPARC Violation)                    | Refactor Code (Post-Features/Test Fix)    | Medium   | No                   | Poor maintainability, increased complexity & risk (esp. `handleSubmit`).      |
| **Code Gen**| Generated `FormDataStore` type uses `any` in `registrationQuestions.ts`         | Update Generation Script                  | Low      | No                   | Reduces component type safety when accessing `state.answers`.                 |
| **Docs**    | File upload via terminal needs definition (V3 Spec 3.8.1)                     | Update Documentation                      | Low      | No (Spec Gap)        | Blocks P3 submission feature design.                                          |
| **Docs**    | Philosophical text management strategy TBD (V3 Spec 3.3.4)                    | Update Documentation                      | Low      | No (Spec Gap)        | Blocks P2 Library/Gamification backend design.                                |
| **Docs**    | Older V1/V2 specs/arch documents exist                                          | Archive Obsolete Docs                     | Low      | No                   | Reduces confusion, ensures focus on current V3 specs.                         |
| **Docs**    | `phase_3_plan.md` lacks detail in dependencies, testing strategy, risk mitigation | Enhance Plan Documentation                | Low      | No                   | Improves clarity and reduces risk for future implementation phases.           |

## 8. Highest Priority Next Step (Revised Recommendation)

**Delegate Detailed Test Suite Refactoring:** The critical blocker remains the poor state of `RegistrationDialog.test.tsx`. Its unreliability prevents confident development. **Create a new task for `tdd` or `optimizer` mode** with the specific goal: "Refactor `RegistrationDialog.test.tsx` based on the detailed recommendations in `docs/reviews/holistic_review_20250424.md` (Section 4), focusing on reducing repetition (using helper functions), improving state assertions, addressing timing workarounds (`REG-TEST-TIMING-001`), and ensuring assertions strictly align with V3.1 spec requirements (including uncommenting/fixing validation checks like those for ranking)." Only after the test suite is reliable should work begin on implementing the missing component logic (ranked-choice, email confirmation, partial registration loading).
